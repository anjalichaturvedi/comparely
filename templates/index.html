{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>Track Product Prices</h2>
        <form method="POST" id="tracker-form">
            <div class="mb-3" id="url-inputs">
                <div class="input-group mb-2">
                    <input type="url" class="form-control" name="product_url" placeholder="Enter Amazon or Flipkart product URL" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="addMoreInputs()">+ Add More</button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Track Prices</button>
        </form>

        {% if products %}
            <div class="mt-4">
                <h3>Product Details</h3>
                <div class="row" id="product-cards">
                    {% for product in products %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            {% if product.image %}
                            <img src="{{ product.image }}" class="card-img-top product-image" alt="{{ product.title }}">
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ product.title }}</h5>
                                <p class="card-text">
                                    <strong>Price:</strong> ₹{{ product.price }}<br>
                                    <strong>Rating:</strong> {{ product.rating }}<br>
                                    <strong>Source:</strong> {{ product.source }}
                                </p>
                                <a href="{{ product.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View Product</a>
                                <button onclick="fetchPriceHistory('{{ product.url }}')" class="btn btn-sm btn-outline-info">Show History</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

    <div id="chart-container" 
     data-dates="{{ dates | tojson | safe }}"
     data-prices="{{ prices | tojson | safe }}"></div>
     
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Price History</h5>
            </div>
            <div class="card-body">
                <canvas id="priceChart"></canvas>
                <div id="chartPlaceholder" class="text-muted text-center py-4">
                    {% if not (dates and prices) %}
                    <p>No price history to display</p>
                    <p>Track a product to see its price history</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add more URL input fields
    function addMoreInputs() {
        const container = document.getElementById('url-inputs');
        const newInput = document.createElement('div');
        newInput.className = 'input-group mb-2';
        newInput.innerHTML = `
            <input type="url" class="form-control" name="product_url" placeholder="Enter another product URL">
            <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
        `;
        container.appendChild(newInput);
    }

    // Price chart variable
    let priceChart = null;

    // Initialize chart if we have price history data
    document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('chart-container');
    if (container) {
        try {
            const dates = JSON.parse(container.dataset.dates);
            const prices = JSON.parse(container.dataset.prices);
            if (dates && prices) {
                renderPriceChart(dates, prices);
            }
        } catch (e) {
            console.error('Error loading chart data:', e);
        }
    }
});

    // Function to render or update the price chart
    function renderPriceChart(dates, prices) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        const placeholder = document.getElementById('chartPlaceholder');
        
        // Hide placeholder when showing chart
        if (placeholder) placeholder.style.display = 'none';
        
        // Destroy previous chart if it exists
        if (priceChart) {
            priceChart.destroy();
        }
        
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Price History (₹)',
                    data: prices,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '₹' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    }

    // Function to fetch price history via AJAX
    function fetchPriceHistory(url) {
        fetch('/price-history?url=' + encodeURIComponent(url))
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.dates && data.prices) {
                    renderPriceChart(data.dates, data.prices);
                } else {
                    showChartError("No historical data available");
                }
            })
            .catch(error => {
                console.error('Error fetching price history:', error);
                showChartError("Failed to load price history");
            });
    }

    function showChartError(message) {
        const placeholder = document.getElementById('chartPlaceholder');
        if (placeholder) {
            placeholder.innerHTML = `<p class="text-danger">${message}</p>`;
            placeholder.style.display = 'block';
        }
        if (priceChart) {
            priceChart.destroy();
            priceChart = null;
        }
    }
</script>
{% endblock %}
